@model HelpDesk.Models.Ticket
@using HelpDesk.Constants

@{
    ViewData["Title"] = "Szczegóły zgłoszenia";

    string LoginOf(string? email)
        => string.IsNullOrWhiteSpace(email) ? "-" : (email.Contains("@") ? email.Split('@')[0] : email);
}

<div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-3">
    <div>
        <h1 class="page-title mb-1">Szczegóły zgłoszenia</h1>
        <div class="page-lead">Podgląd danych zgłoszenia oraz komentarze.</div>
    </div>

    <div class="d-flex gap-2">
        <a class="btn btn-outline-primary" asp-action="Index">Powrót</a>
        <a class="btn btn-outline-primary" asp-action="Edit" asp-route-id="@Model.Id">Edytuj</a>
    </div>
</div>

<div class="card mb-3">
    <div class="card-body p-4">
        <dl class="row mb-0">
            <dt class="col-sm-3">Tytuł</dt>
            <dd class="col-sm-9 fw-bold">@Model.Title</dd>

            <dt class="col-sm-3">Opis</dt>
            <dd class="col-sm-9">@Model.Description</dd>

            <dt class="col-sm-3">Utworzono</dt>
            <dd class="col-sm-9">@Model.CreatedAt.ToString("dd.MM.yyyy HH:mm:ss")</dd>

            <dt class="col-sm-3">Kategoria</dt>
            <dd class="col-sm-9">@Model.Category?.Name</dd>

            <dt class="col-sm-3">Priorytet</dt>
            <dd class="col-sm-9">@Model.Priority?.Name</dd>

            <dt class="col-sm-3">Status</dt>
            <dd class="col-sm-9">@Model.Status</dd>

            <dt class="col-sm-3">Użytkownik</dt>
            <dd class="col-sm-9">@LoginOf(Model.User?.Email)</dd>

            <dt class="col-sm-3">Przypisany do</dt>
            <dd class="col-sm-9">
                @(
                                string.IsNullOrWhiteSpace(Model.AssignedToUserId)
                                ? "Nieprzypisane"
                                : LoginOf(Model.AssignedTo?.Email)
                                )
            </dd>
        </dl>
    </div>
</div>

<div class="card">
    <div class="card-body p-4">
        <h3 class="fw-bold mb-3">Komentarze</h3>

        @if (Model.Comments == null || !Model.Comments.Any())
        {
            <p class="text-muted mb-3">Brak komentarzy.</p>
        }
        else
        {
            foreach (var c in Model.Comments.OrderByDescending(x => x.CreatedAt))
            {
                <div class="comment">
                    <div class="comment-meta">
                        <span class="comment-author">@LoginOf(c.User?.Email)</span>
                        <span>•</span>
                        <span>@c.CreatedAt.ToString("dd.MM.yyyy HH:mm:ss")</span>
                    </div>
                    <div class="comment-body">@c.Content</div>
                </div>
            }
        }

        <form asp-controller="TicketComments" asp-action="Create" method="post" class="mt-3">
            @Html.AntiForgeryToken()
            <input type="hidden" name="ticketId" value="@Model.Id" />

            <div class="mb-2">
                <label class="form-label fw-semibold">Dodaj komentarz</label>
                <textarea name="content" class="form-control" rows="4" placeholder="Napisz komentarz..."></textarea>
            </div>

            <button type="submit" class="btn btn-primary">Dodaj komentarz</button>
        </form>
    </div>
</div>
